---
title: "R Notebook v2"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Setup
## Load packages
```{r Setup}
library(shiny)
library(shinythemes)
library(readr)
library(stringr)
library(dplyr)
library(DT)
library(tools)
library(tidyr)
library(data.table)
```


## Load data
```{r Load data}
dataset_file_name <- "mye_2017_wards.RData"

load(dataset_file_name)
working_popn_set <- mye_2017_wards %>%
    ungroup() %>% 
    select(LAD18NM,WD18NM
           , Sex, Age, Count
           ,Count_in_IMD2015_decile_1
           ,Count_in_IMD2015_decile_1_to_2
           ,Count_in_IMD2015_decile_1_to_3
           , Popn_estimate_source) %>% 
    mutate(Country = "England"
           ,UK = "United Kingdom")

```

# UI and Server
## Build UI
```{r UI}
# Define UI
ui <- fluidPage(
    # App title
    titlePanel("Population", windowTitle = "Population"),
    
    # Sidebar layout with a input and output definitions
    sidebarLayout(
        
        # Inputs
        sidebarPanel(
            
            # Select variable for Sex
            selectInput(inputId = "selected_sex" 
                        ,label = "Sex"
                        ,choices = c("Persons"
                                     ,"Males"
                                     ,"Females")
                        ,selected = "Persons"
            ),
            
            # Select variable for geographical level to display values for
            selectInput(inputId = "geo_group" 
                        ,label = "Geography"
                        ,choices = c("National" = "Country"
                                     ,"Local authority" = "LAD18NM"
                                     ,"Ward" = "WD18NM"
                        )
                        ,selected = "National"
            ),
            
            
            # Select variable to choose LA
            selectInput(inputId = "selected_authority" 
                        ,label = "Local Authority"
                        ,choices = c("-- All Local Authorities --",c(levels(working_popn_set$LAD18NM))) 
                        ,selected = "Southend-on-Sea"
                        ,multiple = TRUE
            ),
            
            # Select age
            wellPanel(
                h3("Define age groups"),
                h5("Use sliders to define different age groups"),
                h6("Note: 90 = 90+"),
                sliderInput(inputId = "age_group_1"
                            ,label = "Age group 1"
                            ,min = 0
                            ,max = 90
                            ,value = c(0,4)
                            ,ticks = TRUE),
                sliderInput(inputId = "age_group_2"
                            ,label = "Age group 2"
                            ,min = 0
                            ,max = 90
                            ,value = c(5,15)
                            ,ticks = TRUE),
                sliderInput(inputId = "age_group_3"
                            ,label = "Age group 3"
                            ,min = 0
                            ,max = 90
                            ,value = c(16,64)
                            ,ticks = TRUE),
                sliderInput(inputId = "age_group_4"
                            ,label = "Age group 4"
                            ,min = 0
                            ,max = 90
                            ,value = c(65,90)
                            ,ticks = TRUE)
            )
        ),
        
        # Output:
        mainPanel(
            
            tabsetPanel(type = "tabs",
                        id = "tabsetpanel",
                        
                        tabPanel(title = "Population- Counts"
                                 ,br()
                                 ,textOutput("source_desc") 
                                 ,br()
                                 ,DT::dataTableOutput(outputId = "popntable_count")),
                        
                        tabPanel(title = "Population - Percentages by group"
                                 ,br()
                                 ,textOutput("source_desc2") 
                                 ,br()
                                 ,DT::dataTableOutput(outputId = "popntable_pct")),
                        
                        tabPanel(title = "Deprivation - Counts"
                                 ,br()
                                 ,textOutput("source_desc3") 
                                 ,br()
                                 ,DT::dataTableOutput(outputId = "deptable_count")),
                        
                        tabPanel(title = "Deprivation - Percentages by group"
                                 ,br()
                                 ,textOutput("source_desc4") 
                                 ,br()
                                 ,DT::dataTableOutput(outputId = "deptable_pct"))
            )
        )
    )
)
```


## Server
Uncomment these test parameters to run the server part independently of the UI
```{r Test parameters}
# input <- list()
# input$geo_group <- "LAD18NM"
# input$selected_authority <-  "Southend-on-Sea"
# input$age_group_1 <- c(0,4)
# input$age_group_2 <- c(5,15)
# input$age_group_3 <- c(16,64)
# input$age_group_4 <- c(65,90)
# input$selected_sex <- "Persons"
# input$dont_filter_la <-  TRUE
```

```{r Server}
# Define server function required to create the scatterplot
server <- function(input, output, session) {
    
    
    # Create a subset of data filtering for selected geography
    popn_selected <- reactive({
        req(input$selected_authority)        
        dont_filter_la <- case_when(
            input$geo_group == "Country" ~ TRUE
            ,input$selected_authority == "-- All Local Authorities --" ~ TRUE
            ,TRUE ~ FALSE
        )
        
        
        parent_area <- case_when(
            input$geo_group == "Country" ~ "UK"
            ,input$geo_group == "LAD18NM" ~ "Country"
            ,input$geo_group == "WD18NM" ~ "LAD18NM"
            ,TRUE ~"ERROR")
        
        denoms <- working_popn_set %>%
            ungroup() %>% 
            filter(Sex == "Persons") %>%
            group_by_at(vars(input$geo_group,parent_area)) %>% 
            summarise(Area_Denom = sum(Count))
        
        working_popn_set <- working_popn_set %>% 
            left_join(denoms)
        
        ag1 <- paste("a. ",input$age_group_1[1]," to ",input$age_group_1[2])
        ag2 <- paste("b. ",input$age_group_2[1]," to ",input$age_group_2[2])
        ag3 <- paste("c. ",input$age_group_3[1]," to ",input$age_group_3[2])
        ag4 <- paste("d. ",input$age_group_4[1]," to ",input$age_group_4[2])
        
        
        popn_selected <- working_popn_set %>% 
            
            filter(Sex == input$selected_sex) %>%
            
            filter(if(dont_filter_la == TRUE){
                LAD18NM %in% levels(working_popn_set$LAD18NM)      
            } else {
                LAD18NM %in%  input$selected_authority
            }) %>%
            
            
            mutate(age_cat = case_when(
                between(Age,input$age_group_1[1],input$age_group_1[2]) ~ ag1
                ,between(Age,input$age_group_2[1],input$age_group_2[2]) ~ag2
                ,between(Age,input$age_group_3[1],input$age_group_3[2]) ~ag3
                ,between(Age,input$age_group_4[1],input$age_group_4[2]) ~ag4)
                
            )%>% 
            
            
            group_by_at(vars(input$geo_group,parent_area,age_cat)) %>%
            
            mutate(Popn_estimate_source = as.character(Popn_estimate_source)
            ) %>% 
            
            summarise(Area_Total = unique(Area_Denom)
                      ,Count = sum(Count)
                      ,Percent_of_area_total = sum(Count)/unique(Area_Denom)
                      ,number_dec_1_to_3 = sum(Count_in_IMD2015_decile_1_to_3)
                      ,pct_dec_1_to_3=sum(Count_in_IMD2015_decile_1_to_3/sum(Count))) %>%
            
            rename("Area" = 1
                   ,"Parent" = 2
                   ,"Age cat" = 3
                   ,"Total popn of area" = 4
                   ,"Number in selected age group" = 5
                   ,"% of area total in this group" = 6
                   ,"Number of selected age group living in IMD deciles 1-3" = 7
                   ,"% of the selected age group living in IMD deciles 1-3" = 8)
        
 
        
    })            
         
            
    output$popntable_count <- DT::renderDataTable(
        DT::datatable(data = popn_selected()[c("Area"
                                               ,"Parent"
                                               ,"Age cat"
                                               ,"Number in selected age group")] %>% 
                          spread('Age cat',"Number in selected age group")
                      ,options = list(pageLength = 20)
                      ,rownames = FALSE)  %>%
            formatRound(3:100
                        ,mark = ","
                        , digits = 0)
    )
    
    
    output$popntable_pct <- DT::renderDataTable(
        DT::datatable(data = popn_selected()[c("Area"
                                               ,"Parent"
                                               ,"Age cat"
                                               ,"% of area total in this group")]  %>% 
                          spread('Age cat',"% of area total in this group")
                      ,options = list(pageLength = 20)
                      ,rownames = FALSE) %>% 
            formatPercentage(3:100
                             , digits = 1)
    )
    
    output$deptable_count <- DT::renderDataTable(
        DT::datatable(data = popn_selected()[c("Area"
                                               ,"Parent"
                                               ,"Age cat"
                                               ,"Number of selected age group living in IMD deciles 1-3")] %>% 
                          spread('Age cat',"Number of selected age group living in IMD deciles 1-3")
                      ,options = list(pageLength = 20)
                      ,rownames = FALSE)  %>% 
            formatRound(3:100
                        ,mark = ","
                        ,digits = 0)
    )
    
    output$deptable_pct <- DT::renderDataTable(
        DT::datatable(data = popn_selected()[c("Area"
                                               ,"Parent"
                                               ,"Age cat"
                                               ,"% of the selected age group living in IMD deciles 1-3")] %>% 
                          spread('Age cat',"% of the selected age group living in IMD deciles 1-3")
                      ,options = list(pageLength = 20)
                      ,rownames = FALSE)  %>% 
            formatPercentage(3:100
                             , digits = 1)
    )
    
    
    # Create description of table
    output$source_desc <- renderText({
        paste(input$geo_group, " level population and deprivation. Population figures from 2017 mid year population estimate. Deprivation figures from English Indices of Deprivation 2015")
    })
    
    output$source_desc2 <- renderText({
        paste(input$geo_group, " level population and deprivation. Population figures from 2017 mid year population estimate. Deprivation figures from English Indices of Deprivation 2015")
    })
    
    output$source_desc3 <- renderText({
        paste(input$geo_group, " level population and deprivation. Population figures from 2017 mid year population estimate. Deprivation figures from English Indices of Deprivation 2015")
    })
    
    output$source_desc3 <- renderText({
        paste(input$geo_group, " level population and deprivation. Population figures from 2017 mid year population estimate. Deprivation figures from English Indices of Deprivation 2015")
    })
    
}



# Create Shiny app object
shinyApp(ui = ui, server = server)

```